# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

## –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ Service Worker

–û—Ç–∫—Ä–æ–π—Ç–µ DevTools (F12) ‚Üí Application ‚Üí Service Workers

–î–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å:
- `firebase-messaging-sw.js` - Status: **activated and is running**

–ï—Å–ª–∏ –Ω–µ—Ç, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –Ω–∞ –æ—à–∏–±–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.

## –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ FCM —Ç–æ–∫–µ–Ω–∞

1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
2. –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É
3. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12 ‚Üí Console)
4. –ù–∞–∂–º–∏—Ç–µ "–í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è" (–≤ –ø—Ä–æ—Ñ–∏–ª–µ –∏–ª–∏ –∞–¥–º–∏–Ω–∫–µ)

–í –∫–æ–Ω—Å–æ–ª–∏ –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
```
‚úÖ Firebase Messaging –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–æ
üîë FCM Token –ø–æ–ª—É—á–µ–Ω: dXXXXXXXXXXXXXXXXXX...
‚úÖ FCM —Ç–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: <userId>
```

## –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ Firestore

Firebase Console ‚Üí Firestore Database ‚Üí users ‚Üí {userId}

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–µ:
```
fcmTokens: ["dXXXXXXXXXXXXXXXXXXXXXX..."]
```

## –®–∞–≥ 4: –¢–µ—Å—Ç foreground —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

1. **–î–µ—Ä–∂–∏—Ç–µ –≤–∫–ª–∞–¥–∫—É –û–¢–ö–†–´–¢–û–ô**
2. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ (–Ω–æ–≤—ã–π –∑–∞–∫–∞–∑, —Ç–æ–≤–∞—Ä, —Å–º–µ–Ω–∞ —Å—Ç–∞—Ç—É—Å–∞)
3. –í –∫–æ–Ω—Å–æ–ª–∏ –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è:

```
üì© –ü–æ–ª—É—á–µ–Ω–æ FCM —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (foreground): {notification: {...}, data: {...}}
üì¨ –î–æ–±–∞–≤–ª—è–µ–º FCM —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç: {title: "...", body: "..."}
‚ûï –î–æ–±–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: {id: "...", title: "...", ...}
üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: {total: 1, unread: 1}
```

4. **–ö–æ–ª–æ–∫–æ–ª—å—á–∏–∫ –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å –∫—Ä–∞—Å–Ω—É—é —Ç–æ—á–∫—É**
5. –ö–ª–∏–∫ –Ω–∞ –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫ ‚Üí –¥–æ–ª–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

## –®–∞–≥ 5: –¢–µ—Å—Ç background —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

1. –î–∞–π—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –¥–∞–ª–∏)
2. **–ó–ê–ö–†–û–ô–¢–ï –≤–∫–ª–∞–¥–∫—É** (–∏–ª–∏ —Å–≤–µ—Ä–Ω–∏—Ç–µ –±—Ä–∞—É–∑–µ—Ä)
3. –ò–∑ –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞/–±—Ä–∞—É–∑–µ—Ä–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Å–æ–±—ã—Ç–∏–µ (–∑–∞–∫–∞–∑, —Ç–æ–≤–∞—Ä)
4. **–î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è —Å–∏—Å—Ç–µ–º–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ** –æ—Ç –±—Ä–∞—É–∑–µ—Ä–∞

–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ Service Worker:
- DevTools ‚Üí Console (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç–∞ –î–û –∑–∞–∫—Ä—ã—Ç–∏—è –≤–∫–ª–∞–¥–∫–∏)
- –î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è:
```
[firebase-messaging-sw.js] Received background message {notification: {...}}
```

## –®–∞–≥ 6: –†—É—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Cloud Function

### –í–∞—Ä–∏–∞–Ω—Ç –ê: –ß–µ—Ä–µ–∑ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞

```javascript
// 1. –ü–æ–ª—É—á–∏—Ç–µ —Å–≤–æ–π FCM —Ç–æ–∫–µ–Ω
const userId = 'YOUR_USER_ID'; // –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π
const db = firebase.firestore();
const userDoc = await db.collection('users').doc(userId).get();
const tokens = userDoc.data().fcmTokens;
console.log('–ú–æ–∏ —Ç–æ–∫–µ–Ω—ã:', tokens);

// 2. –í—ã–∑–æ–≤–∏—Ç–µ callable —Ñ—É–Ω–∫—Ü–∏—é
const functions = firebase.functions();
const sendNotification = functions.httpsCallable('sendNotification');
await sendNotification({
  tokens: tokens, // –∏–ª–∏ –º–∞—Å—Å–∏–≤ —Ç–æ–∫–µ–Ω–æ–≤ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  title: 'üß™ –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ',
  body: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã Cloud Functions',
  icon: '/logo192.png',
  data: { type: 'test', timestamp: Date.now() }
});
```

### –í–∞—Ä–∏–∞–Ω—Ç –ë: –ß–µ—Ä–µ–∑ Firebase Console

1. Cloud Functions ‚Üí sendNotification ‚Üí Testing
2. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è: —É–∫–∞–∂–∏—Ç–µ UID –∞–¥–º–∏–Ω–∞
3. Request body:
```json
{
  "data": {
    "tokens": ["dXXXXXXXXXXXXXXXXXXXXXX..."],
    "title": "–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ",
    "body": "–ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ –∫–æ–Ω—Å–æ–ª—å",
    "icon": "/logo192.png",
    "data": {
      "type": "test"
    }
  }
}
```

### –í–∞—Ä–∏–∞–Ω—Ç –í: –ß–µ—Ä–µ–∑ Postman/curl

```bash
# –ü–æ–ª—É—á–∏—Ç–µ ID token –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
firebase auth:export users.json
# –ò–ª–∏ —á–µ—Ä–µ–∑ SDK: await firebase.auth().currentUser.getIdToken()

curl -X POST \
  https://us-central1-dreamshop-odessa.cloudfunctions.net/sendNotification \
  -H "Authorization: Bearer YOUR_ID_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "data": {
      "tokens": ["FCM_TOKEN_HERE"],
      "title": "Test",
      "body": "Testing from curl",
      "data": {"type": "test"}
    }
  }'
```

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç –í–û–û–ë–©–ï

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
1. Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω? (DevTools ‚Üí Application)
2. FCM —Ç–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω? (–∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞)
3. –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ Firestore? (users/{userId}/fcmTokens)
4. Cloud Functions –∑–∞–¥–µ–ø–ª–æ–µ–Ω—ã? (Firebase Console ‚Üí Functions)
5. VAPID –∫–ª—é—á –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π? (src/firebase/config.ts)

**–ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤ –∫–æ–Ω—Å–æ–ª–∏:**
```javascript
console.log('Notification permission:', Notification.permission);
navigator.serviceWorker.getRegistrations().then(r => console.log('SW:', r));
```

### Foreground —Ä–∞–±–æ—Ç–∞–µ—Ç, Background –ù–ï–¢

**–ü—Ä–∏—á–∏–Ω—ã:**
- Service Worker –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ DevTools ‚Üí Application)
- –ë—Ä–∞—É–∑–µ—Ä –±–ª–æ–∫–∏—Ä—É–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (Settings ‚Üí Notifications)
- –ö–æ–Ω—Ñ–∏–≥ –≤ `firebase-messaging-sw.js` –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```javascript
// –í public/firebase-messaging-sw.js
// –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ firebaseConfig –ò–î–ï–ù–¢–ò–ß–ï–ù src/firebase/config.ts
```

### Background —Ä–∞–±–æ—Ç–∞–µ—Ç, Foreground –ù–ï–¢

**–ü—Ä–∏—á–∏–Ω—ã:**
- `onMessage` listener –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω
- NotificationContext –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Å–æ–ª–∏:**
–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```
üì© –ü–æ–ª—É—á–µ–Ω–æ FCM —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (foreground): ...
```

–ï—Å–ª–∏ –ù–ï–¢ ‚Üí –ø—Ä–æ–±–ª–µ–º–∞ –≤ `messaging.ts` –∏–ª–∏ `NotificationContext.tsx`

### –ú–µ—Ç–∫–∞ (–∫—Ä–∞—Å–Ω–∞—è —Ç–æ—á–∫–∞) –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω—ã:**
- `unreadCount` === 0
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```javascript
// –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞
localStorage.getItem('dreamshop_notifications')
```

–î–æ–ª–∂–µ–Ω –±—ã—Ç—å JSON –º–∞—Å—Å–∏–≤ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏.

**–ï—Å–ª–∏ –ø—É—Å—Ç–æ:**
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è ‚Üí –ø—Ä–æ–≤–µ—Ä—å—Ç–µ `addNotification`
- localStorage –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω ‚Üí –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞

### Cloud Function –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É

**permission-denied:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–¥–º–∏–Ω ‚Üí —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `isAdmin: true` –≤ Firestore
- –ù–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω ‚Üí –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É

**UNAUTHENTICATED:**
- –ù–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ‚Üí –ø—Ä–æ–≤–µ—Ä—å—Ç–µ `context.auth` –≤ callable —Ñ—É–Ω–∫—Ü–∏–∏

**–¢–æ–∫–µ–Ω—ã –ø—É—Å—Ç—ã–µ:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –¥–∞–ª —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
- –¢–æ–∫–µ–Ω—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Firestore

## –§–∏–Ω–∞–ª—å–Ω—ã–π —á–µ–∫–ª–∏—Å—Ç

- [x] Firebase Project –Ω–∞—Å—Ç—Ä–æ–µ–Ω (`dreamshop-odessa`)
- [x] Cloud Functions –∑–∞–¥–µ–ø–ª–æ–µ–Ω—ã (Node 20)
- [x] Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω (`firebase-messaging-sw.js`)
- [x] VAPID –∫–ª—é—á –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ–Ω—Ñ–∏–≥
- [x] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–∞–ª —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- [x] FCM —Ç–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ Firestore (`users/{userId}/fcmTokens`)
- [x] `onMessage` listener –ø–æ–¥–ø–∏—Å–∞–Ω –≤ `NotificationContext`
- [x] `onBackgroundMessage` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ SW
- [x] NotificationBell –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫—Ä–∞—Å–Ω—É—é —Ç–æ—á–∫—É –ø—Ä–∏ `unreadCount > 0`
- [x] Cloud Functions –ª–æ–≥–∏—Ä—É—é—Ç –æ—Ç–ø—Ä–∞–≤–∫—É (Firebase Console ‚Üí Functions ‚Üí Logs)

**–ï—Å–ª–∏ –≤—Å–µ —á–µ–∫–±–æ–∫—Å—ã ‚úÖ ‚Äî —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –î–û–õ–ñ–ù–´ —Ä–∞–±–æ—Ç–∞—Ç—å!**

---

–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å? –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
- Firebase Console ‚Üí Functions ‚Üí Logs (–æ—à–∏–±–∫–∏ —Ñ—É–Ω–∫—Ü–∏–π)
- Browser Console (–æ—à–∏–±–∫–∏ JS)
- DevTools ‚Üí Application ‚Üí Service Workers (—Å—Ç–∞—Ç—É—Å SW)
- DevTools ‚Üí Network ‚Üí fcm endpoint (–∑–∞–ø—Ä–æ—Å—ã –∫ FCM)
