# Быстрая проверка Push-уведомлений

## 1. Откройте приложение
```
npm start
```

## 2. Войдите как пользователь
- Зарегистрируйтесь или войдите через Google

## 3. Дайте разрешение на уведомления
**Вариант А:** Через профиль
- Перейдите в "Профиль" → кнопка "Включить уведомления"

**Вариант Б:** Через админку (для админов)
- Админ панель → кнопка "Включить уведомления"

После разрешения:
- FCM токен сохранится в Firestore (`users/{userId}/fcmTokens`)
- В консоли браузера увидите: `✅ FCM Token: ...`

## 4. Проверка фоновых уведомлений

### Тест 1: Новый заказ (уведомление админу)
1. Откройте приложение в **двух вкладках/браузерах**:
   - Вкладка A: админ (включите уведомления)
   - Вкладка B: обычный пользователь
2. **Сверните/закройте вкладку A** (админ)
3. В вкладке B создайте заказ (добавьте товар в корзину → оформите)
4. **Админ получит системное уведомление** даже при закрытой вкладке!

### Тест 2: Изменение статуса заказа (уведомление пользователю)
1. Пользователь открыл приложение, включил уведомления
2. **Закройте вкладку пользователя**
3. Админ меняет статус заказа (Админ панель → Заказы → изменить статус)
4. Пользователь получит уведомление в фоне

### Тест 3: Новый товар (уведомление админу)
1. Админ включил уведомления
2. **Сверните браузер**
3. Добавьте товар через Firestore Console или другую сессию
4. Админ получит уведомление о новом товаре

## 5. Отладка

### Chrome DevTools
```
F12 → Application → Service Workers
```
Убедитесь что `firebase-messaging-sw.js` активен (статус: activated, running)

### Консоль браузера
При получении уведомления в фоне:
```
[firebase-messaging-sw.js] Received background message {notification: ...}
```

### Firebase Console
```
https://console.firebase.google.com/project/dreamshop-odessa/functions/logs
```
Проверьте логи функций:
- `onOrderCreated` — отправка при создании заказа
- `onOrderStatusUpdated` — отправка при изменении статуса
- Ошибки, если токены невалидны

## Решение проблем

### Уведомления не приходят в фоне
- Проверьте что Service Worker зарегистрирован (DevTools → Application)
- Убедитесь что разрешение дано: `Notification.permission === "granted"`
- Проверьте наличие FCM токена в Firestore (`users/{userId}/fcmTokens`)

### Ошибка "VAPID key not configured"
- Добавьте реальный VAPID ключ в `src/firebase/config.ts`
- Получите: Firebase Console → Project Settings → Cloud Messaging → Web Push certificates

### Service Worker не регистрируется
- Убедитесь что приложение запущено через HTTPS или localhost
- Проверьте что файл `public/firebase-messaging-sw.js` существует
- Очистите кеш браузера (Ctrl+Shift+Del)

### Уведомления дублируются
- Это нормально если вкладка открыта: одно от `onMessage`, одно от SW
- Закройте вкладку для теста чисто фоновых уведомлений

## Быстрая команда для теста
После входа в приложение выполните в консоли браузера:
```javascript
// Проверка разрешения
console.log('Permission:', Notification.permission);

// Проверка Service Worker
navigator.serviceWorker.getRegistrations().then(r => console.log('SW:', r));

// Запрос разрешения (если еще не дано)
Notification.requestPermission().then(p => console.log('New permission:', p));
```

---

**Готово!** Теперь push-уведомления работают как в активном, так и в фоновом режиме.
